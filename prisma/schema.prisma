datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

/*
  MODELOS PRINCIPAIS:

  - Usuario: dados de login e papel global (papelGlobal).
  - Clube: grupo (ex.: "Águias da Serra").
  - Unidade: subdivisão dentro do clube (cada conselheiro/desbravador pertence a uma).
  - MembroClube: vínculo Usuario <-> Clube + Unidade + papel dentro do clube.
  - Prova: criada dentro de um clube (e opcionalmente de uma unidade), com visibilidade.
  - Questao: questões de múltipla escolha, dissertativas ou práticas.
  - RespostaProva: respostas enviadas por um membro.
*/

model Usuario {
  id                Int              @id @default(autoincrement())
  nome              String
  email             String           @unique
  senhaHash         String?          // opcional para login com Google
  papelGlobal       PapelGlobal      @default(USUARIO) // papel global (MASTER, etc.)
  fotoPerfilUrl     String?

  // Verificação de email
  emailVerificado   Boolean          @default(false)
  tokenVerificacao  String?          @unique

  // Recuperação de senha
  tokenRecuperacaoSenha  String?     @unique
  tokenRecuperacaoExpira DateTime?

  // OAuth Google
  googleId          String?          @unique

  // Controle de criação de clube (ADMIN_CLUBE pode criar apenas 1)
  clubeCriadoId     Int?             @unique

  criadoEm          DateTime         @default(now())
  atualizadoEm      DateTime         @updatedAt

  membrosClube      MembroClube[]
  provasCriadas     Prova[]          @relation("ProvasCriadas")
  provasAutoria     Prova[]          @relation("ProvasAutoria")
  respostas         RespostaProva[]
  clubeCriado       Clube?           @relation("ClubeCriado", fields: [clubeCriadoId], references: [id])
  regionaisClubes   RegionalClube[]  @relation("RegionalClubes")
}

enum PapelGlobal {
  USUARIO   // padrão
  MASTER    // admin global da plataforma
  REGIONAL  // supervisor regional - supervisiona múltiplos clubes
}

model Clube {
  id        Int            @id @default(autoincrement())
  nome      String
  slug      String         @unique   // "aguias-da-serra"

  // Localização
  cidade    String
  estado    String
  pais      String         @default("Brasil")
  latitude  Float?
  longitude Float?

  criadoEm  DateTime       @default(now())
  atualizadoEm DateTime    @updatedAt

  membros   MembroClube[]
  unidades  Unidade[]
  provas    Prova[]
  criadoPor Usuario?       @relation("ClubeCriado")
  regionais RegionalClube[] @relation("RegionaisClubes")
}

model Unidade {
  id        Int          @id @default(autoincrement())
  clubeId   Int
  nome      String
  criadoEm  DateTime     @default(now())

  clube     Clube        @relation(fields: [clubeId], references: [id])
  membros   MembroClube[]
  provas    Prova[]
}

model MembroClube {
  id                Int           @id @default(autoincrement())
  usuarioId         Int
  clubeId           Int
  unidadeId         Int?
  papel             PapelClube
  status            StatusMembro   @default(PENDENTE)

  // Dados adicionais do membro
  dataNascimento    DateTime
  batizado          Boolean        @default(false)
  cargoEspecifico   String?        // Diretor, Capitão, Secretário, etc.

  criadoEm          DateTime       @default(now())
  atualizadoEm      DateTime       @updatedAt

  usuario           Usuario        @relation(fields: [usuarioId], references: [id])
  clube             Clube          @relation(fields: [clubeId], references: [id])
  unidade           Unidade?       @relation(fields: [unidadeId], references: [id])

  @@unique([usuarioId, clubeId]) // um vínculo único por usuário por clube
}

enum PapelClube {
  ADMIN_CLUBE
  DIRETORIA     // acesso total às provas do clube, sem unidade fixa
  CONSELHEIRO   // mínimo 16 anos, batizado
  INSTRUTOR     // não batizado + 18+ anos (automático)
  DESBRAVADOR
}

enum StatusMembro {
  PENDENTE
  ATIVO
  BLOQUEADO
}

model RegionalClube {
  id          Int      @id @default(autoincrement())
  regionalId  Int      // Usuario com PapelGlobal.REGIONAL
  clubeId     Int

  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  regional    Usuario  @relation("RegionalClubes", fields: [regionalId], references: [id], onDelete: Cascade)
  clube       Clube    @relation("RegionaisClubes", fields: [clubeId], references: [id], onDelete: Cascade)

  @@unique([regionalId, clubeId])
  @@index([regionalId])
  @@index([clubeId])
}

enum CategoriaEspecialidade {
  ADRA
  ARTES_E_HABILIDADES_MANUAIS
  ATIVIDADES_AGRICOLAS
  ATIVIDADES_MISSIONARIAS_E_COMUNITARIAS
  ATIVIDADES_PROFISSIONAIS
  ATIVIDADES_RECREATIVAS
  CIENCIA_E_SAUDE
  ESTUDOS_DA_NATUREZA
  HABILIDADES_DOMESTICAS
}

model Prova {
  id                  Int                      @id @default(autoincrement())
  titulo              String
  descricao           String?                  @db.Text
  categoria           CategoriaEspecialidade
  clubeId             Int
  unidadeId           Int?                     // Obrigatório se PRIVADA_UNIDADE
  criadorId           Int
  autorOriginalId     Int?                     // Se copiada, mantém autor original
  provaOriginalId     Int?                     // Se copiada, referencia prova original
  visibilidade        VisibilidadeProva        @default(PRIVADA_CLUBE)
  urlReferenciaMDA    String?                  // Slug da especialidade no MDA Wiki

  criadoEm            DateTime                 @default(now())
  atualizadoEm        DateTime                 @updatedAt

  clube               Clube                    @relation(fields: [clubeId], references: [id])
  unidade             Unidade?                 @relation(fields: [unidadeId], references: [id])
  criador             Usuario                  @relation("ProvasCriadas", fields: [criadorId], references: [id])
  autorOriginal       Usuario?                 @relation("ProvasAutoria", fields: [autorOriginalId], references: [id])
  provaOriginal       Prova?                   @relation("CopiaProva", fields: [provaOriginalId], references: [id])
  copias              Prova[]                  @relation("CopiaProva")
  questoes            Questao[]
  respostas           RespostaProva[]

  @@index([clubeId])
  @@index([unidadeId])
  @@index([criadorId])
  @@index([visibilidade])
}

enum VisibilidadeProva {
  PUBLICA           // Qualquer clube pode copiar (biblioteca global)
  PRIVADA_CLUBE     // Apenas membros do clube
  PRIVADA_UNIDADE   // Apenas membros da unidade específica
}

model Questao {
  id               Int           @id @default(autoincrement())
  provaId          Int
  tipo             TipoQuestao
  enunciado        String        @db.Text
  opcoes           Json?         // { "a": "...", "b": "...", "c": "...", "d": "..." }
  respostaCorreta  String?       // "a" | "b" | "c" | "d" ou critérios de avaliação
  pontuacao        Int           @default(1)
  ordem            Int           // Ordem da questão na prova

  criadoEm         DateTime      @default(now())
  atualizadoEm     DateTime      @updatedAt

  prova            Prova         @relation(fields: [provaId], references: [id], onDelete: Cascade)

  @@index([provaId])
}

enum TipoQuestao {
  MULTIPLA_ESCOLHA
  DISSERTATIVA
  PRATICA           // Requer upload de foto como evidência
}

model RespostaProva {
  id                      Int       @id @default(autoincrement())
  provaId                 Int
  usuarioId               Int
  respostas               Json       // ex: { "1": "A", "2": "C", ... }
  notaObjetiva            Float?
  notaDissertativa        Float?
  notaFinal               Float?
  corrigidaAutomaticamente Boolean   @default(false)
  precisaCorrecaoManual   Boolean    @default(false)
  criadoEm                DateTime   @default(now())

  prova                   Prova      @relation(fields: [provaId], references: [id])
  usuario                 Usuario    @relation(fields: [usuarioId], references: [id])
}
